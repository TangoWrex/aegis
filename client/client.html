<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aegis Client Interface</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
        .container { display: flex; height: 100vh; }
        #map { flex: 2; border: 1px solid #333; }
        .sidebar { flex: 1; display: flex; flex-direction: column; padding: 10px; background: #f0f0f0; border-left: 1px solid #333; }
        #chat-messages { flex: 1; overflow-y: auto; padding: 10px; background: white; border: 1px solid #ccc; margin-bottom: 10px; }
        #chat-form { display: flex; margin-bottom: 10px; }
        #chat-input { flex-grow: 1; padding: 5px; }
        #docs { overflow-y: auto; padding: 10px; background: #fff; border: 1px solid #ccc; margin-bottom: 10px; }
        .dropdown {
            position: relative; display: inline-block; margin-bottom: 10px;
        }
        .dropbtn {
            background-color: #4CAF50; color: white; padding: 5px; border: none; cursor: pointer; font-size: 12px;
        }
        .dropdown-content {
            display: none; position: absolute; background-color: #f9f9f9; min-width: 100px; box-shadow: 0 8px 16px rgba(0,0,0,0.2); z-index: 1;
        }
        .dropdown-content button {
            color: black; padding: 5px 10px; text-decoration: none; display: block; width: 100%; text-align: left; background: none; border: none;
        }
        .dropdown-content button:hover { background-color: #ddd; }
        .dropdown:hover .dropdown-content { display: block; }
    </style>
</head>
<body>
    <div class="container">
        <div id="map"></div>
        <div class="sidebar">
            <h3>Chat</h3>
            <div class="dropdown">
                <button class="dropbtn">Menu</button>
                <div class="dropdown-content">
                    <button id="clear-chat-btn">Clear Chat</button>
                </div>
            </div>
            <div id="chat-messages"></div>
            <form id="chat-form">
                <input type="text" id="chat-input" placeholder="Type a message...">
                <button type="submit">Send</button>
            </form>
            <h3>Documents</h3>
            <div id="docs"></div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const API_KEY = 'your_api_key_here'; // Replace with actual API key or fetch from env
        const DEVICE_ID = 'client_' + Math.random().toString(36).substr(2, 9); // Unique client ID
        const SERVER_URL = 'http://localhost:8000/api';

        // Initialize map
        var map = L.map('map').setView([44.369, -85.977], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: 'Â© OpenStreetMap'
        }).addTo(map);

        var markers = {};
        function updateMap() {
            fetch(`${SERVER_URL}/locations/`, {
                headers: { 'X-API-Key': API_KEY }
            })
            .then(response => response.json())
            .then(data => {
                data.forEach(loc => {
                    var key = loc.device_id;
                    if (!markers[key]) {
                        markers[key] = L.marker([loc.lat, loc.lon]).bindPopup(loc.device_id).addTo(map);
                    } else {
                        markers[key].setLatLng([loc.lat, loc.lon]);
                    }
                });
            })
            .catch(error => console.error('Error updating map:', error));
        }
        updateMap();
        setInterval(updateMap, 5000);

        // Chat functionality
        function updateChat() {
            fetch(`${SERVER_URL}/chat/`, {
                headers: { 'X-API-Key': API_KEY }
            })
            .then(response => response.json())
            .then(data => {
                var chatMessages = document.getElementById('chat-messages');
                chatMessages.innerHTML = '';
                let colorIndex = 0;
                data.forEach(msg => {
                    var div = document.createElement('div');
                    div.style.margin = '5px 0';
                    div.style.textAlign = 'left';
                    div.style.padding = '5px';
                    div.style.background = colorIndex % 2 === 0 ? '#f5f5f5' : '#ffffff';
                    div.style.borderRadius = '5px';
                    div.textContent = `[${msg.timestamp}] ${msg.device_id}: ${msg.message}`;
                    chatMessages.appendChild(div);
                    colorIndex++;
                });
                chatMessages.scrollTop = chatMessages.scrollHeight;
            })
            .catch(error => console.error('Error updating chat:', error));
        }

        document.getElementById('chat-form').addEventListener('submit', function(e) {
            e.preventDefault();
            var message = document.getElementById('chat-input').value;
            if (message) {
                fetch(`${SERVER_URL}/chat/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': API_KEY
                    },
                    body: JSON.stringify({ device_id: DEVICE_ID, message: message })
                }).then(response => {
                    if (response.ok) {
                        document.getElementById('chat-input').value = '';
                        updateChat();
                    }
                });
            }
        });

        document.getElementById('clear-chat-btn').addEventListener('click', function() {
            var chatMessages = document.getElementById('chat-messages');
            chatMessages.innerHTML = ''; // Clear only local chat display
        });

        // Documents functionality
        function updateDocs() {
            fetch(`${SERVER_URL}/documents/`, {
                headers: { 'X-API-Key': API_KEY }
            })
            .then(response => response.json())
            .then(data => {
                var docsDiv = document.getElementById('docs');
                docsDiv.innerHTML = '<h4>Available Documents:</h4>';
                data.forEach(doc => {
                    var p = document.createElement('p');
                    p.textContent = `${doc.title} - ${doc.file_path || 'No file path'}`;
                    docsDiv.appendChild(p);
                });
            })
            .catch(error => console.error('Error updating documents:', error));
        }

        // Initial updates and polling
        updateMap();
        updateChat();
        updateDocs();
        setInterval(updateMap, 5000);
        setInterval(updateChat, 5000);
    </script>
</body>
</html>